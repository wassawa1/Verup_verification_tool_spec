name: Version Upgrade Verification Pipeline

on: 
  push:
  workflow_dispatch:
    inputs:
      example:
        description: 'Example to run (iverilog, python, template, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - iverilog
          - python
          - template

jobs:
  verify:
    name: 'Verify ${{ matrix.example }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example: ${{ (github.event.inputs.example || 'all') == 'all' && fromJSON('["iverilog", "python", "template"]') || fromJSON(format('["{0}"]', github.event.inputs.example || 'all')) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Icarus Verilog (for iverilog example)
        if: matrix.example == 'iverilog'
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog

      - name: Setup example
        run: make setup-${{ matrix.example }}

      - name: Run verification pipeline
        run: make test

      - name: Display report summary
        if: always()
        run: |
          echo "üìã Verification Report:"
          ls -lrt reports/*.md 2>/dev/null | tail -1 || echo "‚ùå No reports found"
          echo ""
          if [ -f reports/report-*.md ]; then
            LATEST_REPORT=$(ls -t reports/report-*.md | head -1)
            echo "=== Report Summary ==="
            tail -20 "$LATEST_REPORT"
          fi

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report-${{ matrix.example }}
          path: reports/*.md
          retention-days: 30



